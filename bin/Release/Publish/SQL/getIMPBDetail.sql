DECLARE @@DATE VARCHAR(MAX);
SET @@DATE = (SELECT TOP 1 DATE FROM TB_R_WP_SECURITY_CHECK WHERE (CHECK_OUT = '' OR CHECK_OUT IS NULL) ORDER BY DATE ASC);
--GET Incident

IF(@@DATE IS NOT NULL)
BEGIN

SELECT 
(SELECT COUNT(X.TB_M_EMPLOYEE_ID) FROM TB_R_WP_DAILY AS Z INNER JOIN TB_R_WP_DAILY_WORKER_LIST AS X ON Z.ID  = X.TB_R_WP_DAILY_ID WHERE Z.TB_R_WP_PROJECT_JOB_ID = B.ID) AS TOTAL_EMPLOYEE,
(SELECT 
COUNT(ID_TB_M_EMPLOYEE) FROM TB_R_WP_SECURITY_CHECK WHERE ID_TB_R_WP_PROJECT_JOB_ID = B.ID and  CONVERT(date, getdate()) >= CONVERT(date, DATE) AND CONVERT(date, getdate()) <= CONVERT(date, DATE)) AS TOTAL_CHECK_IN,
B.CREATED_BY,
B.JOB_NAME AS PROJECT_JOBS,D.PROJECT_NAME, 
(CASE WHEN C.EXECUTOR = 2
		THEN 
			(SELECT COMPANY_NAME FROM TB_M_COMPANY WHERE ID_TB_M_COMPANY = C.ID_TB_M_COMPANY)
		ELSE 
			(SELECT COMPANY_NAME FROM TB_M_COMPANY WHERE ID_TB_M_COMPANY = C.ID_TB_M_COMPANY)
		END
		) AS SECTION,
B.WP_IMPB_NO as IMPB, A.TOP_POSITION, A.LEFT_POSITION, A.HEIGHT, A.WIDTH, A.PING, A.WINDOW_HEIGHT, A.WINDOW_WIDTH,
A.BORDER_COLOR, A.ROTATION, B.JOB_NAME, B.JOB_STATUS,
(SELECT (FIRST_NAME + ' ' +LAST_NAME) FROM TB_M_EMPLOYEE WHERE ID_TB_M_EMPLOYEE = E.EMPLOYEE_LEAD_PROJECT) AS LEADER,
(SELECT (FIRST_NAME + ' ' +LAST_NAME) FROM TB_M_EMPLOYEE WHERE ID_TB_M_EMPLOYEE = E.EXECUTOR) AS EXECUTOR,
(SELECT (FIRST_NAME + ' ' +LAST_NAME) FROM TB_M_EMPLOYEE WHERE ID_TB_M_EMPLOYEE = E.EMPLOYEE_SUPERVISOR_PROJECT) AS SUPERVISOR,
(SELECT TOP 1 (FIRST_NAME + ' ' +LAST_NAME) FROM TB_M_EMPLOYEE WHERE ID_TB_M_EMPLOYEE = F.ID_TB_M_EMPLOYEE) AS SUPERVISOR_TMMIN
FROM TB_R_IMPB_LOCATION AS A
LEFT JOIN TB_R_WP_PROJECT_JOB AS B ON A.ID_TB_R_WP_PROJECT_JOB = B.ID
LEFT JOIN TB_R_WP_DETAIL_IMPLEMENTOR AS C ON B.ID = C.WP_PROJECT_JOB_ID
LEFT JOIN TB_R_WP_PROJECT AS D ON D.ID = B.WP_PROJECT_ID
LEFT JOIN TB_R_WP_DETAIL_IMPLEMENTOR AS E ON E.WP_PROJECT_JOB_ID = B.ID
LEFT JOIN TB_R_WP_DETAIL_SUPERVISION AS F ON F.WP_PROJECT_JOB_ID = B.ID
WHERE D.ID_TB_M_AREA = @AREA
AND CONVERT(date, @@DATE) >= CONVERT(date, B.START_DATE) AND CONVERT(date, getdate()) <= CONVERT(date, B.END_DATE) 
ORDER BY HEIGHT, WIDTH DESC

END
ELSE
BEGIN
SELECT 
(SELECT COUNT(X.TB_M_EMPLOYEE_ID) FROM TB_R_WP_DAILY AS Z INNER JOIN TB_R_WP_DAILY_WORKER_LIST AS X ON Z.ID  = X.TB_R_WP_DAILY_ID WHERE Z.TB_R_WP_PROJECT_JOB_ID = B.ID) AS TOTAL_EMPLOYEE,
(SELECT 
COUNT(ID_TB_M_EMPLOYEE) FROM TB_R_WP_SECURITY_CHECK WHERE ID_TB_R_WP_PROJECT_JOB_ID = B.ID and  CONVERT(date, getdate()) >= CONVERT(date, DATE) AND CONVERT(date, getdate()) <= CONVERT(date, DATE)) AS TOTAL_CHECK_IN,
B.CREATED_BY,
B.JOB_NAME AS PROJECT_JOBS,D.PROJECT_NAME, 
(CASE WHEN C.EXECUTOR = 2
		THEN 
			(SELECT COMPANY_NAME FROM TB_M_COMPANY WHERE ID_TB_M_COMPANY = C.ID_TB_M_COMPANY)
		ELSE 
			(SELECT COMPANY_NAME FROM TB_M_COMPANY WHERE ID_TB_M_COMPANY = C.ID_TB_M_COMPANY)
		END
		) AS SECTION,
B.WP_IMPB_NO as IMPB, A.TOP_POSITION, A.LEFT_POSITION, A.HEIGHT, A.WIDTH, A.PING, A.WINDOW_HEIGHT, A.WINDOW_WIDTH,
A.BORDER_COLOR, A.ROTATION, B.JOB_NAME, B.JOB_STATUS,
(SELECT (FIRST_NAME + ' ' +LAST_NAME) FROM TB_M_EMPLOYEE WHERE ID_TB_M_EMPLOYEE = E.EMPLOYEE_LEAD_PROJECT) AS LEADER,
(SELECT (FIRST_NAME + ' ' +LAST_NAME) FROM TB_M_EMPLOYEE WHERE ID_TB_M_EMPLOYEE = E.EXECUTOR) AS EXECUTOR,
(SELECT (FIRST_NAME + ' ' +LAST_NAME) FROM TB_M_EMPLOYEE WHERE ID_TB_M_EMPLOYEE = E.EMPLOYEE_SUPERVISOR_PROJECT) AS SUPERVISOR,
(SELECT TOP 1 (FIRST_NAME + ' ' +LAST_NAME) FROM TB_M_EMPLOYEE WHERE ID_TB_M_EMPLOYEE = F.ID_TB_M_EMPLOYEE) AS SUPERVISOR_TMMIN
FROM TB_R_IMPB_LOCATION AS A
LEFT JOIN TB_R_WP_PROJECT_JOB AS B ON A.ID_TB_R_WP_PROJECT_JOB = B.ID
LEFT JOIN TB_R_WP_DETAIL_IMPLEMENTOR AS C ON B.ID = C.WP_PROJECT_JOB_ID
LEFT JOIN TB_R_WP_PROJECT AS D ON D.ID = B.WP_PROJECT_ID
LEFT JOIN TB_R_WP_DETAIL_IMPLEMENTOR AS E ON E.WP_PROJECT_JOB_ID = B.ID
LEFT JOIN TB_R_WP_DETAIL_SUPERVISION AS F ON F.WP_PROJECT_JOB_ID = B.ID
WHERE D.ID_TB_M_AREA = @AREA
AND CONVERT(date, getdate()) >= CONVERT(date, B.START_DATE) AND CONVERT(date, getdate()) <= CONVERT(date, B.END_DATE) 
ORDER BY HEIGHT, WIDTH DESC
END
