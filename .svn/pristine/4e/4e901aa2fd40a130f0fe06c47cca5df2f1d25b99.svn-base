DECLARE @@DATE VARCHAR(MAX);
SET @@DATE = (SELECT TOP 1 DATE FROM TB_R_WP_SECURITY_CHECK WHERE (CHECK_OUT = '' OR CHECK_OUT IS NULL) ORDER BY DATE ASC);
--GET Incident

IF(@@DATE IS NOT NULL)
BEGIN
	SELECT 
	ISNULL(sum(case when A.PING = 1 then 1 else  0 end), 0) AS INCIDENT_L,
	ISNULL(sum(case when A.PING = 2 then 1 else 0 end), 0) AS INCIDENT_M,
	ISNULL(sum(case when A.PING = 3 then 1 else 0 end), 0) AS INCIDENT_H
	FROM TB_R_IMPB_LOCATION AS A
	INNER JOIN TB_R_WP_PROJECT_JOB AS B ON A.ID_TB_R_WP_PROJECT_JOB = B.ID
	INNER JOIN TB_R_WP_PROJECT AS C ON C.ID = B.WP_PROJECT_ID
	WHERE C.ID_TB_M_AREA = @AREA
	AND CONVERT(date, @@DATE) >= CONVERT(date, B.START_DATE) AND CONVERT(date, getdate()) <= CONVERT(date, B.END_DATE) 
END
ELSE
BEGIN
	SELECT 
	ISNULL(sum(case when A.PING = 1 then 1 else  0 end), 0) AS INCIDENT_L,
	ISNULL(sum(case when A.PING = 2 then 1 else 0 end), 0) AS INCIDENT_M,
	ISNULL(sum(case when A.PING = 3 then 1 else 0 end), 0) AS INCIDENT_H
	FROM TB_R_IMPB_LOCATION AS A
	INNER JOIN TB_R_WP_PROJECT_JOB AS B ON A.ID_TB_R_WP_PROJECT_JOB = B.ID
	INNER JOIN TB_R_WP_PROJECT AS C ON C.ID = B.WP_PROJECT_ID
	WHERE C.ID_TB_M_AREA = @AREA
	AND CONVERT(date, getdate()) >= CONVERT(date, B.START_DATE) AND CONVERT(date, getdate()) <= CONVERT(date, B.END_DATE) 
END