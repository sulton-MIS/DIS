DECLARE @@QUERY VARCHAR(MAX);
DECLARE @@ERR VARCHAR(MAX);
DECLARE @@CHK VARCHAR(20);
SET @@QUERY = '';

BEGIN TRY

SET @@QUERY = '
	SELECT
		TOP 1
		A.ID_TB_M_EMPLOYEE AS ID,
		C.ID as ID_PROJECT,
		A.REG_NO,
		B.FIRST_NAME AS ANZEN_LEADER,
		A.EMAIL,
		A.CHECK_IN,
		(SELECT COMPANY_NAME FROM TB_M_COMPANY WHERE ID_TB_M_COMPANY = A.ID_TB_M_COMPANY) AS COMPANY,
		A.IDENTITY_TYPE,
		A.IDENTITY_NO AS NO_IDENTITY,
		A.PHONE,
		A.PIC_STATUS,
		A.FIRST_NAME,
		CONVERT(DATE, A.ANZEN_DT_FROM) AS ANZEN_VALID_FROM,
		CONVERT(DATE, A.ANZEN_DT_TO) AS ANZEN_VALID_TO,
		A.ANZEN_DT_TO,
		A.LAST_NAME,
		A.SAFETY_INDUCTION_NO AS NO_SAFETY_INDUCTION,
		CONVERT(DATE, A.SAFETY_INDUCTION_FROM) AS VALID_DARI,
		CONVERT(DATE, A.SAFETY_INDUCTION_TO) AS VALID_SAMPAI,
		A.SECTION,
		A.ANZEN_SERTIFICATE_NO,
		A.GENDER,
		(CASE WHEN G.ID_EXECUTOR = 2
		THEN 
			(SELECT COMPANY_NAME FROM TB_M_COMPANY WHERE ID_TB_M_COMPANY = G.ID_TB_M_COMPANY)
		ELSE 
			G.SECTION
		END
		) AS BAGIAN,
		A.ADDRESS AS ALAMAT,
		D.WP_IMPB_NO AS IMPB_NO,
		C.PROJECT_NAME AS NAMA_PROYEK,
		E.AREA_NAME AS AREA,
		F.LOC_NAME AS LOKASI_PROYEK,
		C.WORKING_STATUS AS STATUS_IJIN_KERJA,
		C.DEP_OR_DIV_CODE AS DIVISI,
		C.IMPLEMENT_DATE_FROM AS MULAI_PELAKSANAAN,
		C.IMPLEMENT_DATE_TO AS AKHIR_PELAKSANAAN,
		G.EXECUTOR AS PELAKSANA_PROYEK,
		G.EMPLOYEE_LEAD_PROJECT AS PIMPINAN_PELAKSANAAN,
		G.EMPLOYEE_SUPERVISOR_PROJECT AS PENGAWAS_PELAKSANAAN,
		H.SHIFT_HOUR AS JAM_PELAKSANAAN,
		(CASE WHEN A.CHECK_IN = 1 THEN ''OUT'' ELSE ''IN'' END) AS SECURITY_CHECK
	FROM
		TB_M_EMPLOYEE AS A LEFT JOIN
		(SELECT FIRST_NAME, LAST_NAME, ANZEN_SERTIFICATE_NO FROM TB_M_EMPLOYEE WHERE PIC_STATUS = ''PMP'') AS B ON A.ANZEN_SERTIFICATE_NO = B.ANZEN_SERTIFICATE_NO LEFT JOIN
		(SELECT TB_R_WP_PROJECT.ID, TB_R_WP_PROJECT_JOB.ID AS ID_TB_R_WP_PROJECT_JOB, IMPLEMENT_DATE_FROM, IMPLEMENT_DATE_TO, PROJECT_NAME, ID_TB_M_AREA, ID_TB_M_LOCATION, WORKING_STATUS, DEP_OR_DIV_CODE FROM TB_R_WP_PROJECT INNER JOIN TB_R_WP_PROJECT_JOB ON TB_R_WP_PROJECT.ID = TB_R_WP_PROJECT_JOB.WP_PROJECT_ID) AS C ON A.ID_TB_R_WP_PROJECT_JOB = C.ID_TB_R_WP_PROJECT_JOB LEFT JOIN
		(SELECT ID, WP_PROJECT_ID, WP_IMPB_NO FROM TB_R_WP_PROJECT_JOB) AS D ON C.ID = D.WP_PROJECT_ID LEFT JOIN
		(SELECT AREA_NAME, ID_TB_M_AREA FROM TB_M_AREA) AS E ON E.ID_TB_M_AREA = C.ID_TB_M_AREA LEFT JOIN
		(SELECT LOC_NAME, ID_TB_M_LOCATION FROM TB_M_LOCATION) AS F ON F.ID_TB_M_LOCATION = C.ID_TB_M_LOCATION LEFT JOIN
		(SELECT WP_PROJECT_JOB_ID,TME1.SECTION, TB_R_WP_DETAIL_IMPLEMENTOR.ID_TB_M_COMPANY, EXECUTOR AS ID_EXECUTOR, (TME1.FIRST_NAME + '' '' + TME1.LAST_NAME) AS EXECUTOR, (TME2.FIRST_NAME + '' '' + TME2.LAST_NAME) AS EMPLOYEE_LEAD_PROJECT, (TME3.FIRST_NAME +'' ''+TME3.LAST_NAME) AS EMPLOYEE_SUPERVISOR_PROJECT FROM TB_R_WP_DETAIL_IMPLEMENTOR 
		LEFT JOIN TB_M_EMPLOYEE AS TME1 ON TB_R_WP_DETAIL_IMPLEMENTOR.EXECUTOR = TME1.ID_TB_M_EMPLOYEE 
		LEFT JOIN TB_M_EMPLOYEE AS TME2 ON TB_R_WP_DETAIL_IMPLEMENTOR.EMPLOYEE_LEAD_PROJECT = TME2.ID_TB_M_EMPLOYEE 
		LEFT JOIN TB_M_EMPLOYEE AS TME3 ON TB_R_WP_DETAIL_IMPLEMENTOR.EMPLOYEE_SUPERVISOR_PROJECT = TME3.ID_TB_M_EMPLOYEE) AS G ON G.WP_PROJECT_JOB_ID = C.ID LEFT JOIN
		(SELECT WP_PROJECT_JOB_ID, SHIFT_ID, (SELECT SYSTEM_VALUE_TXT FROM TB_M_SYSTEM WHERE SYSTEM_ID = ''WP_WORKING_HOURS'' AND SYSTEM_TYPE = ''SHIFT'' +CONVERT(VARCHAR(5),TB_R_WP_DETAIL_SHIFT.SHIFT_ID) ) AS SHIFT_HOUR FROM TB_R_WP_DETAIL_SHIFT) AS H ON H.WP_PROJECT_JOB_ID = C.ID
	WHERE 1 = 1 ';

IF(@TYPE = 'ID_CARD')
BEGIN
	SET @@QUERY = @@QUERY + 'AND A.REG_NO = '''+@scanQR+'''';
END
ELSE
BEGIN
	SET @@QUERY = @@QUERY + 'AND D.WP_IMPB_NO = '''+@scanQR+''' AND A.PIC_STATUS = ''PMP''';
END

END TRY
BEGIN CATCH
	SET @@CHK = 'FALSE';
	SET @@ERR = 'ERROR Detail Error :|: ' + ERROR_MESSAGE() + ' :|: ';	
END CATCH

EXEC(@@QUERY)

SELECT @@CHK, @@ERR;