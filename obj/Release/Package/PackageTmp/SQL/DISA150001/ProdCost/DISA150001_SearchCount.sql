DECLARE @@QUERY VARCHAR(MAX);
DECLARE @@DATA_ID VARCHAR(MAX) = @DATA_ID;


SET @@QUERY = '';
SET @@QUERY = '
	SELECT ISNULL(max(ROW_NUM),0) FROM 
	(
	SELECT 
		ROW_NUMBER() OVER (ORDER BY DMC_TYPE ASC) ROW_NUM,		
		DMC_TYPE as ID,	
		DMC_TYPE,
		CUSTOMER,
		LOT_SIZE,
		AIR_CIF_SALES_PRICE,
		SEA_JPN_SALES_PRICE,
		AIR_SHA_SALES_PRICE,
		SEA_SHA_SALES_PRICE,
		AIR_HKG_SALES_PRICE,
		SEA_HKG_SALES_PRICE,
		FOB_SALES_PRICE,
		VERSI_WIS,
		CAVITY_FILM,
		CAVITY_GLASS,
		CAVITY_TAIL,
		TOUCH_PANEL_TYPE,
		RANK,
		TOUCH_PANEL_SIZE,
		AIR_CIF_MATERIAL_COST,
		LABOUR_COST_PRINTING,
		LABOUR_COST_NON_PRINTING,	
		LABOUR_COST_ETCHING,
		LABOUR_COST_PRESS,	
		LABOUR_COST_ASSEMBLY,
		LABOUR_COST_KOMPO,
		TOTAL_DIRECT_LABOUR,
		INDIRECT_LABOUR,
		LABOUR_SGA,
		AIR_JPN,
		SEA_TOKYO,
		AIR_SHA,
		SEA_SHA,
		AIR_HKG,
		SEA_HKG,
		AIR_CIF_SALES_PRICE + (TOTAL_DIRECT_LABOUR + INDIRECT_LABOUR + LABOUR_SGA) + AIR_JPN as TOTAL_COST_AIR_JPN,
		AIR_CIF_SALES_PRICE + (TOTAL_DIRECT_LABOUR + INDIRECT_LABOUR + LABOUR_SGA) + SEA_TOKYO as TOTAL_COST_SEA_JPN,
		AIR_CIF_SALES_PRICE + (TOTAL_DIRECT_LABOUR + INDIRECT_LABOUR + LABOUR_SGA) + AIR_SHA as TOTAL_COST_AIR_SHA,
		AIR_CIF_SALES_PRICE + (TOTAL_DIRECT_LABOUR + INDIRECT_LABOUR + LABOUR_SGA) + SEA_SHA as TOTAL_COST_SEA_SHA,
		AIR_CIF_SALES_PRICE + (TOTAL_DIRECT_LABOUR + INDIRECT_LABOUR + LABOUR_SGA) + AIR_HKG as TOTAL_COST_AIR_HKG,
		AIR_CIF_SALES_PRICE + (TOTAL_DIRECT_LABOUR + INDIRECT_LABOUR + LABOUR_SGA) + SEA_HKG as TOTAL_COST_SEA_HKG,
		AIR_CIF_SALES_PRICE + (TOTAL_DIRECT_LABOUR + INDIRECT_LABOUR + LABOUR_SGA) as TOTAL_COST_FOB,
		YIELD_PRINTING_FILM
	FROM
		(
		SELECT
			SP.DMC_TYPE,
			PC.CUSTOMER,
			PC.LOT_SIZE,
			SP.AIR_CIF_SALES_PRICE,
			SP.SEA_JPN_SALES_PRICE,
			SP.AIR_SHA_SALES_PRICE,
			SP.SEA_SHA_SALES_PRICE,
			SP.AIR_HKG_SALES_PRICE,
			SP.SEA_HKG_SALES_PRICE,
			SP.FOB_SALES_PRICE,
			PC.VERSI_WIS,
			PC.CAVITY_FILM,
			PC.CAVITY_GLASS,
			PC.CAVITY_TAIL,
			PC.TOUCH_PANEL_TYPE,
			PC.RANK,
			PC.TOUCH_PANEL_SIZE,
			SP.AIR_CIF_MATERIAL_COST,
			SP.LABOUR_COST_PRINTING,
			SP.LABOUR_COST_NON_PRINTING,	
			SP.LABOUR_COST_ETCHING,
			SP.LABOUR_COST_PRESS,	
			SP.LABOUR_COST_ASSEMBLY,
			SP.LABOUR_COST_KOMPO,

			(
				SP.LABOUR_COST_PRINTING +
				SP.LABOUR_COST_NON_PRINTING +	
				SP.LABOUR_COST_ETCHING +
				SP.LABOUR_COST_PRESS +	
				SP.LABOUR_COST_ASSEMBLY +
				SP.LABOUR_COST_KOMPO
			) as TOTAL_DIRECT_LABOUR,

			(
				SP.LABOUR_COST_PRINTING +
				SP.LABOUR_COST_NON_PRINTING +	
				SP.LABOUR_COST_ETCHING +
				SP.LABOUR_COST_PRESS +	
				SP.LABOUR_COST_ASSEMBLY +
				SP.LABOUR_COST_KOMPO
			) * PC.INDIRECT as INDIRECT_LABOUR,	

			(
				SP.AIR_CIF_MATERIAL_COST +
				(
				SP.LABOUR_COST_PRINTING +
				SP.LABOUR_COST_NON_PRINTING +	
				SP.LABOUR_COST_ETCHING +
				SP.LABOUR_COST_PRESS +	
				SP.LABOUR_COST_ASSEMBLY +
				SP.LABOUR_COST_KOMPO
				)
			+
			(
				(
				SP.LABOUR_COST_PRINTING +
				SP.LABOUR_COST_NON_PRINTING +	
				SP.LABOUR_COST_ETCHING +
				SP.LABOUR_COST_PRESS +	
				SP.LABOUR_COST_ASSEMBLY +
				SP.LABOUR_COST_KOMPO
				) * PC.INDIRECT
			)
			*
			PC.SGA
			) as LABOUR_SGA,

			SP.AIR_JPN,
			SP.SEA_TOKYO,
			SP.AIR_SHA,
			SP.SEA_SHA,
			SP.AIR_HKG,
			SP.SEA_HKG,
			PC.YIELD_PRINTING_FILM
		FROM
			ad_dis_pc_sales_price SP
		INNER JOIN
			ad_dis_pc_production_cost PC
		ON SP.DMC_TYPE = PC.DMC_TYPE
		) as [SC]
	WHERE 1=1	
';

IF(@DMC_TYPE <> '')
	BEGIN
		SET @@QUERY = @@QUERY + 'AND DMC_TYPE LIKE ''%'+RTRIM(@DMC_TYPE)+'%'' ';
	END

IF(@CUSTOMER <> '')
	BEGIN
		SET @@QUERY = @@QUERY + 'AND CUSTOMER LIKE ''%'+RTRIM(@CUSTOMER)+'%'' ';
	END
	
IF(@TOUCH_PANEL_TYPE <> '')
	BEGIN
		SET @@QUERY = @@QUERY + 'AND TOUCH_PANEL_TYPE LIKE ''%'+RTRIM(@TOUCH_PANEL_TYPE)+'%'' ';
	END
	
IF(@RANK <> '')
	BEGIN
		SET @@QUERY = @@QUERY + 'AND RANK LIKE ''%'+RTRIM(@RANK)+'%'' ';
	END

SET @@QUERY = @@QUERY+ ') AS TB';


EXEC(@@QUERY);

