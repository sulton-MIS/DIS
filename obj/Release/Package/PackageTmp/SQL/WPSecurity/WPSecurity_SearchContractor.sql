DECLARE @@QUERY VARCHAR(MAX);

SET @@QUERY = '';
SET @@QUERY = '
	SELECT ROW_NUMBER() OVER (ORDER BY A.USERNAME ASC) ROW_NUM,
	A.ID_TB_M_EMPLOYEE AS ID,
	(SELECT COMPANY_NAME FROM TB_M_COMPANY WHERE ID_TB_M_COMPANY = A.ID_TB_M_COMPANY ) AS COMPANY,
	(A.FIRST_NAME + '' '' + A.LAST_NAME) AS FULLNAME,
	(SELECT SYSTEM_VALUE_TXT FROM TB_M_SYSTEM WHERE SYSTEM_ID = ''WP_EMPLOYEE_PIC'' AND SYSTEM_TYPE = A.PIC_STATUS) AS PIC_STATUS,
	SAFETY_INDUCTION_NO,
	CONVERT(VARCHAR(11), A.SAFETY_INDUCTION_TO, 113) AS SAFETY_INDUCTION_TO,
	CONVERT(VARCHAR(11), A.SAFETY_INDUCTION_FROM, 113) AS SAFETY_INDUCTION_FROM,
	REG_NO,
	(CASE WHEN a.SECTION = ''GENERAL'' THEN
			''GENERAL''
		ELSE
			(SELECT distinct TOP 1 DIV FROM [dbo].[TB_M_ORG_RANK] where DIV_ID is not null AND DIV_ID = a.SECTION)		
		END
	) AS SECTION,
	ANZEN_SERTIFICATE_NO,
	ANZEN_DT_FROM,
	ANZEN_DT_TO,
	IDENTITY_NO
	FROM TB_M_EMPLOYEE AS A
	INNER JOIN TB_M_COMPANY AS B ON A.ID_TB_M_COMPANY = B.ID_TB_M_COMPANY
	WHERE 1=1 AND A.IS_DELETED = 0 AND A.SECTION != ''Security'' AND A.SAFETY_INDUCTION_NO != ''''
';

IF(@EMPLOYEE <> '')
BEGIN
	SET @@QUERY = @@QUERY + 'AND (A.FIRST_NAME + A.LAST_NAME) LIKE ''%'+@EMPLOYEE+'%'' ';
END

IF(@COMPANY <> '')
BEGIN
	SET @@QUERY = @@QUERY + 'AND B.COMPANY_NAME LIKE ''%'+@COMPANY+'%'' ';
END

EXEC(@@QUERY)