DECLARE @@DATE VARCHAR(MAX);
SET @@DATE = (SELECT TOP 1 DATE FROM TB_R_WP_SECURITY_CHECK WHERE (CHECK_OUT = '' OR CHECK_OUT IS NULL) ORDER BY DATE ASC);
--GET Incident

IF(@@DATE IS NOT NULL)
BEGIN
	SELECT 
	SUM(CASE WHEN BORDER_COLOR = 'green' THEN 1 ELSE 0 END) AS DANGER_L,
	SUM(CASE WHEN BORDER_COLOR = 'yellow' THEN 1 ELSE 0 END) AS DANGER_M,
	SUM(CASE WHEN BORDER_COLOR = 'red' THEN 1 ELSE 0 END) AS DANGER_H
	FROM TB_R_IMPB_LOCATION AS A 
	INNER JOIN TB_R_WP_PROJECT_JOB AS B ON A.ID_TB_R_WP_PROJECT_JOB = B.ID
	INNER JOIN TB_R_WP_PROJECT AS C ON B.WP_PROJECT_ID = C.ID
	AND CONVERT(date, @@DATE) >= CONVERT(date, B.START_DATE) AND CONVERT(date, getdate()) <= CONVERT(date, B.END_DATE)
	AND C.ID_TB_M_AREA = @AREA
END
ELSE
BEGIN
	SELECT 
	SUM(CASE WHEN BORDER_COLOR = 'green' THEN 1 ELSE 0 END) AS DANGER_L,
	SUM(CASE WHEN BORDER_COLOR = 'yellow' THEN 1 ELSE 0 END) AS DANGER_M,
	SUM(CASE WHEN BORDER_COLOR = 'red' THEN 1 ELSE 0 END) AS DANGER_H
	FROM TB_R_IMPB_LOCATION AS A 
	INNER JOIN TB_R_WP_PROJECT_JOB AS B ON A.ID_TB_R_WP_PROJECT_JOB = B.ID
	INNER JOIN TB_R_WP_PROJECT AS C ON B.WP_PROJECT_ID = C.ID
	AND CONVERT(date, getdate()) >= CONVERT(date, B.START_DATE) AND CONVERT(date, getdate()) <= CONVERT(date, B.END_DATE)
	AND C.ID_TB_M_AREA = @AREA
END